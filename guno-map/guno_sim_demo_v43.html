<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>GUNO v1.0 Sim v43 (Survival Master)</title>
<style>
    :root {
        --jy-color: #00AA00;
        --m-color: #F62E36;
        --g-color: #FF9500;
        --t-color: #009BBF;
        --bg-color: #222;
        --text-color: #eee;
    }
    body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        font-size: 14px;
        overflow-x: hidden;
    }
    h1, h2, h3 { margin: 5px 0; }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #333;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .controls button {
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        background: #555;
        color: #fff;
        border: none;
        border-radius: 4px;
        margin-right: 5px;
    }
    .controls button:hover { background: #777; }
    .controls button.active { background: #00AA00; }
    
    /* Layout */
    .game-container {
        display: grid;
        grid-template-columns: 320px 1fr 300px;
        gap: 20px;
        height: calc(100vh - 100px);
    }
    .panel {
        background: #333;
        padding: 10px;
        border-radius: 8px;
        overflow-y: auto;
    }
    
    /* Card Styles */
    .card {
        display: inline-block;
        width: 60px;
        height: 90px;
        background-color: #fff;
        border-radius: 5px;
        margin: 2px;
        position: relative;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        border: 2px solid #ccc;
    }
    .card.jy { border-color: var(--jy-color); }
    .card.m { border-color: var(--m-color); }
    .card.g { border-color: var(--g-color); }
    .card.t { border-color: var(--t-color); }
    .card.teiden { border-color: #000; box-shadow: 0 0 5px #fff; }
    
    /* Draw Pile Style */
    .card-back {
        width: 60px;
        height: 90px;
        background-color: #444;
        background-image: url('https://geodo.earth/guno-map/cards/GUNO_BACK.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        border: 2px solid #777;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 4px #000, -1px -1px 2px #000;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    }

    /* Map & Slots */
    .map-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 5px;
    }
    .slot {
        background: #444;
        border: 1px dashed #666;
        border-radius: 4px;
        min-height: 95px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        text-align: center;
        opacity: 0.6;
    }
    .slot.active {
        opacity: 1;
        border-style: solid;
        background: #2a2a2a;
    }
    .slot.completed {
        box-shadow: 0 0 8px gold;
    }

    /* Player Area */
    .player-box {
        border: 1px solid #555;
        padding: 5px;
        margin-bottom: 5px;
        border-radius: 4px;
        transition: all 0.3s;
    }
    .player-box.active-turn {
        border-color: #fff;
        background: #444;
        box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }
    .player-box.eliminated {
        opacity: 0.4;
        filter: grayscale(100%);
        border: 1px solid #333;
        background: #111;
    }
    .player-stats {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
    }
    .dropout-badge {
        background: #555; color: #fff; padding: 2px 4px; font-size: 10px; border-radius: 3px;
        display: none;
    }
    .eliminated .dropout-badge { display: inline-block; }

    /* Log */
    #log {
        font-family: monospace;
        font-size: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    .log-turn { color: #aaa; border-bottom: 1px solid #444; margin-top: 5px; }
    .log-play { color: #88ff88; }
    .log-draw { color: #88ccff; }
    .log-win { color: gold; font-weight: bold; font-size: 1.2em; }
    .log-teiden { color: #ffff00; font-weight: bold; }
    .log-reverse { color: #ff88ff; }
    .log-elim { color: #ff4444; font-weight: bold; }
    .log-rank { color: #44ffff; font-weight: bold; }

    /* FX */
    #fx-layer {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 999;
        display: none;
    }
    .flash {
        background: white;
        opacity: 0;
        animation: flashAnim 0.2s ease-out;
    }
    .darken {
        background: black;
        opacity: 0.7;
        transition: opacity 0.5s;
    }
    @keyframes flashAnim {
        0% { opacity: 0.8; }
        100% { opacity: 0; }
    }
    
    .popup-text {
        position: absolute;
        color: gold;
        font-weight: bold;
        font-size: 24px;
        text-shadow: 0 0 5px black;
        animation: floatUp 1s ease-out forwards;
    }
    @keyframes floatUp {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(-30px); opacity: 0; }
    }

    .turn-indicator {
        font-size: 24px;
        margin: 0 10px;
    }

    /* Ranking Table */
    #ranking-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 12px;
    }
    #ranking-table th, #ranking-table td {
        border: 1px solid #555;
        padding: 4px;
        text-align: center;
    }
    #ranking-table th { background: #444; }

</style>
</head>
<body>

<div id="fx-layer"></div>

<div class="header">
    <div>
        <h2>GUNO v1.0 Sim v43 (Survival Master)</h2>
        <small>Priority: Active > GUNO | Zombie Guard ON</small>
    </div>
    <div class="controls">
        <span id="turn-direction" class="turn-indicator">‚Üª</span>
        <button onclick="startGame()">üé≤ New Game</button>
        <button onclick="toggleAuto()" id="btn-auto">‚ñ∂ Auto Play</button>
        <button onclick="step()" id="btn-step">Step</button>
        <span>Speed: <input type="range" id="speed-range" min="10" max="1000" value="100" style="width:80px"> ms</span>
    </div>
</div>

<div class="game-container">
    <!-- LEFT: Log -->
    <div class="panel">
        <h3>Game Log</h3>
        <div id="status-display">Turn: 0 | Active: 4</div>
        <div id="log" style="height: 90%; overflow-y: auto;"></div>
    </div>

    <!-- CENTER: Map -->
    <div class="panel">
        <h3>Shared Map (Completed: <span id="guno-count">0</span>/4)</h3>
        
        <div style="display:flex; justify-content:center; gap:30px; margin: 10px; padding: 10px; background:#222; border-radius:8px;">
            <div style="text-align:center">
                <div style="margin-bottom:5px; color:#aaa; font-size:10px;">DRAW PILE</div>
                <div id="draw-pile-visual" class="card-back">84</div>
            </div>
            <div style="text-align:center">
                <div style="margin-bottom:5px; color:#aaa; font-size:10px;">DISCARD PILE</div>
                <div id="discard-pile" style="height: 90px; min-width:64px;"></div>
            </div>
        </div>

        <h4>JR Yamanote (JY) - Green</h4>
        <div id="map-jy" class="map-grid"></div>
        <h4>Marunouchi (M) - Red</h4>
        <div id="map-m" class="map-grid"></div>
        <h4>Ginza (G) - Orange</h4>
        <div id="map-g" class="map-grid"></div>
        <h4>Tozai (T) - Blue</h4>
        <div id="map-t" class="map-grid"></div>
    </div>

    <!-- RIGHT: Players & Stats -->
    <div class="panel">
        <h3>Players</h3>
        <div id="players-area"></div>
        
        <div id="result-area" style="display:none; margin-top:20px; border-top:1px solid #555; padding-top:10px;">
            <h4 style="color:gold;">üèÜ Final Result</h4>
            <table id="ranking-table">
                <thead><tr><th>Rank</th><th>Name</th><th>GUNO</th><th>Hand Sum</th><th>Status</th></tr></thead>
                <tbody id="ranking-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
/* 
   GUNO v1.0.5 Master Data
*/
const STATIONS_DB = [
    // JY
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:1, st_ja:'Êù±‰∫¨', st_en:'Tokyo', color:'#00AA00', file:'JY_01_Tokyo'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:2, st_ja:'ÊúâÊ•ΩÁî∫', st_en:'Yurakucho', color:'#00AA00', file:'JY_02_Yurakucho'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:3, st_ja:'Êñ∞Ê©ã', st_en:'Shimbashi', color:'#00AA00', file:'JY_03_Shimbashi'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:4, st_ja:'ÂìÅÂ∑ù', st_en:'Shinagawa', color:'#00AA00', file:'JY_04_Shinagawa'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:5, st_ja:'Ê∏ãË∞∑', st_en:'Shibuya', color:'#00AA00', file:'JY_05_Shibuya'}, 
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:6, st_ja:'Êñ∞ÂÆø', st_en:'Shinjuku', color:'#00AA00', file:'JY_06_Shinjuku'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:7, st_ja:'È´òÁî∞È¶¨Â†¥', st_en:'Takadanobaba', color:'#00AA00', file:'JY_07_Takadanobaba'}, 
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:8, st_ja:'Ê±†Ë¢ã', st_en:'Ikebukuro', color:'#00AA00', file:'JY_08_Ikebukuro'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:9, st_ja:'‰∏äÈáé', st_en:'Ueno', color:'#00AA00', file:'JY_09_Ueno'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:10, st_ja:'ÁßãËëâÂéü', st_en:'Akihabara', color:'#00AA00', file:'JY_10_Akihabara'},
    // M
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:1, st_ja:'Ê±†Ë¢ã', st_en:'Ikebukuro', color:'#F62E36', file:'M_01_Ikebukuro'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:2, st_ja:'ËåóËç∑Ë∞∑', st_en:'Myogadani', color:'#F62E36', file:'M_02_Myogadani'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:3, st_ja:'ÂæåÊ•ΩÂúí', st_en:'Korakuen', color:'#F62E36', file:'M_03_Korakuen'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:4, st_ja:'Âæ°Ëå∂„ÉéÊ∞¥', st_en:'Ochanomizu', color:'#F62E36', file:'M_04_Ochanomizu'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:5, st_ja:'Êù±‰∫¨', st_en:'Tokyo', color:'#F62E36', file:'M_05_Tokyo'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:6, st_ja:'ÈäÄÂ∫ß', st_en:'Ginza', color:'#F62E36', file:'M_06_Ginza'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:7, st_ja:'Ëµ§ÂùÇË¶ãÈôÑ', st_en:'Akasaka-mitsuke', color:'#F62E36', file:'M_07_Akasaka-mitsuke'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:8, st_ja:'Âõõ„ÉÑË∞∑', st_en:'Yotsuya', color:'#F62E36', file:'M_08_Yotsuya'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:9, st_ja:'Êñ∞ÂÆø', st_en:'Shinjuku', color:'#F62E36', file:'M_09_Shinjuku'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:10, st_ja:'‰∏≠ÈáéÂùÇ‰∏ä', st_en:'Nakano-sakaue', color:'#F62E36', file:'M_10_Nakano-sakaue'},
    // G
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:1, st_ja:'Ê∏ãË∞∑', st_en:'Shibuya', color:'#FF9500', file:'G_01_Shibuya'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:2, st_ja:'Ë°®ÂèÇÈÅì', st_en:'Omotesando', color:'#FF9500', file:'G_02_Omotesando'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:3, st_ja:'ÈùíÂ±±‰∏Ä‰∏ÅÁõÆ', st_en:'Aoyama-itchome', color:'#FF9500', file:'G_03_Aoyama-itchome'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:4, st_ja:'Ëµ§ÂùÇË¶ãÈôÑ', st_en:'Akasaka-mitsuke', color:'#FF9500', file:'G_04_Akasaka-mitsuke'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:5, st_ja:'Ê∫úÊ±†Â±±Áéã', st_en:'Tameike-sanno', color:'#FF9500', file:'G_05_Tameike-sanno'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:6, st_ja:'Êñ∞Ê©ã', st_en:'Shimbashi', color:'#FF9500', file:'G_06_Shimbashi'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:7, st_ja:'ÈäÄÂ∫ß', st_en:'Ginza', color:'#FF9500', file:'G_07_Ginza'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:8, st_ja:'‰∏äÈáé', st_en:'Ueno', color:'#FF9500', file:'G_08_Ueno'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:9, st_ja:'Á®≤Ëç∑Áî∫', st_en:'Inaricho', color:'#FF9500', file:'G_09_Inaricho'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:10, st_ja:'ÊµÖËçâ', st_en:'Asakusa', color:'#FF9500', file:'G_10_Asakusa'},
    // T
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:1, st_ja:'‰∏≠Èáé', st_en:'Nakano', color:'#009BBF', file:'T_01_Nakano'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:2, st_ja:'ËêΩÂêà', st_en:'Ochiai', color:'#009BBF', file:'T_02_Ochiai'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:3, st_ja:'È´òÁî∞È¶¨Â†¥', st_en:'Takadanobaba', color:'#009BBF', file:'T_03_Takadanobaba'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:4, st_ja:'Êó©Á®≤Áî∞', st_en:'Waseda', color:'#009BBF', file:'T_04_Waseda'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:5, st_ja:'È£ØÁî∞Ê©ã', st_en:'Iidabashi', color:'#009BBF', file:'T_05_Iidabashi'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:6, st_ja:'Â§ßÊâãÁî∫', st_en:'Otemachi', color:'#009BBF', file:'T_06_Otemachi'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:7, st_ja:'Êó•Êú¨Ê©ã', st_en:'Nihombashi', color:'#009BBF', file:'T_07_Nihombashi'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:8, st_ja:'ËåÖÂ†¥Áî∫', st_en:'Kayabacho', color:'#009BBF', file:'T_08_Kayabacho'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:9, st_ja:'ÈñÄÂâç‰ª≤Áî∫', st_en:'Monzen-nakacho', color:'#009BBF', file:'T_09_Monzen-nakacho'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:10, st_ja:'Êù±ÈôΩÁî∫', st_en:'Toyocho', color:'#009BBF', file:'T_10_Toyocho'}
];

const TEIDEN_FILES = {'JY':'JY_TEIDEN', 'M':'M_TEIDEN', 'G':'G_TEIDEN', 'T':'T_TEIDEN'};
const IMAGE_BASE_URL = "https://geodo.earth/guno-map/cards/";

// State
let deck = [];
let discardPile = [];
let players = [];
let turnIndex = 0;
let direction = 1; 
let turnCount = 0;
let mapState = {}; 
let lastHits = {}; 
let gameOver = false;
let autoPlay = false;
let autoTimer = null;

// --- Init ---
function initDeck() {
    deck = [];
    STATIONS_DB.forEach(s => {
        for(let i=0; i<2; i++) {
            deck.push({
                type: 'station',
                lc: s.lc,
                order: s.order, 
                ja: s.st_ja,
                en: s.st_en,
                color: s.color,
                file: s.file,
                id: `card-${s.lc}-${s.order}-${i}`
            });
        }
    });
    // Teiden x4
    ['JY', 'M', 'G', 'T'].forEach(lc => {
        deck.push({
            type: 'teiden',
            lc: lc, 
            order: 20, 
            color: '#000',
            file: TEIDEN_FILES[lc],
            id: `teiden-${lc}-0`
        });
    });
    shuffle(deck);
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function startGame() {
    stopAuto();
    gameOver = false;
    turnCount = 0;
    turnIndex = 0;
    direction = 1;
    mapState = {};
    lastHits = {};
    document.getElementById('result-area').style.display = "none";
    
    players = [
        { name: "P1", hand: [], guno: 0, completed: [], status: 'active' },
        { name: "P2", hand: [], guno: 0, completed: [], status: 'active' },
        { name: "P3", hand: [], guno: 0, completed: [], status: 'active' },
        { name: "P4", hand: [], guno: 0, completed: [], status: 'active' }
    ];
    
    document.getElementById('log').innerHTML = "";
    document.getElementById('turn-direction').textContent = "‚Üª";
    
    initDeck();
    
    for(let p of players) {
        for(let i=0; i<7; i++) {
            if(deck.length) p.hand.push(deck.pop());
        }
    }
    
    discardPile = [];
    let initialCard;
    while(true) {
        initialCard = deck.pop();
        discardPile.push(initialCard);
        if(initialCard.type === 'station') {
            const key = `${initialCard.lc}-${initialCard.order}`;
            mapState[key] = -1; 
            break;
        }
    }
    
    updateStatusDisplay();
    log("=== GAME START (v43 Survival Master) ===");
    log(`Deck: 84 | Rule: 4GUNO or Survivor | Teiden Chain OK`);
    
    renderAll();
}

// --- Logic ---
function step() {
    if(gameOver) return;
    playTurn();
    renderAll();
    if(gameOver) stopAuto();
}

function playTurn() {
    let activePlayers = players.filter(p => p.status === 'active');
    if(activePlayers.length === 0) {
        endGameByScore(); 
        return;
    }
    
    let attempts = 0;
    while(players[turnIndex].status !== 'active' && attempts < 4) {
        advanceTurn();
        attempts++;
    }
    
    const pIndex = turnIndex;
    const player = players[pIndex];
    
    // ‚òÖZOMBIE GUARD: If player is somehow eliminated, skip
    if(player.status !== 'active') {
        advanceTurn();
        return;
    }

    const top = discardPile[discardPile.length - 1];
    
    logTurn(`Turn ${turnCount}: ${player.name}`);
    
    // AI Logic
    let playable = [];
    player.hand.forEach((card, idx) => {
        let isTeiden = (card.type === 'teiden');
        
        if(isTeiden && player.hand.length === 1) return;

        if(isTeiden) {
            if(top.type === 'teiden') {
                playable.push({ card, idx, reason: 'teiden_chain' });
            } else if (card.lc === top.lc) {
                playable.push({ card, idx, reason: 'teiden' });
            }
        } else {
            let match = false;
            let reason = "";
            const topLc = top.lc; 
            const topName = top.ja || ""; 
            
            if (card.lc === topLc) { match = true; reason = "color"; }
            if (card.ja === topName) { match = true; reason = "station"; }
            if (card.type === 'station' && top.type === 'station') {
                if (card.order === top.order) { match = true; reason = "number"; }
            }
            
            if(match) playable.push({ card, idx, reason });
        }
    });
    
    if(playable.length === 0) {
        // Draw
        if(deck.length === 0) {
            log(`Deck empty! Checking scores...`);
            endGameByScore();
            return;
        }
        const drawn = deck.pop();
        player.hand.push(drawn);
        log(`<span class="log-draw">${player.name} draws 1 card.</span>`);
    } else {
        // Play
        let pick = playable[Math.floor(Math.random() * playable.length)];
        
        player.hand.splice(pick.idx, 1);
        discardPile.push(pick.card);
        
        let logMsg = `<span class="log-play">${player.name} plays ${cardStr(pick.card)}</span>`;
        if(pick.reason) logMsg += ` <small>(${pick.reason})</small>`;
        
        if(pick.card.type === 'station') {
            const key = `${pick.card.lc}-${pick.card.order}`;
            if(mapState[key] === undefined) {
                mapState[key] = pIndex;
            }
            checkLastHit(pick.card.lc, pIndex);

            if(top.type === 'station' && top.ja === pick.card.ja) {
                direction *= -1;
                logMsg += ` <span class="log-reverse">REVERSE (Same Station)!</span>`;
                updateDirectionIcon();
            }
        } 
        else if (pick.card.type === 'teiden') {
            logMsg += ` <span class="log-teiden">TEIDEN!‚ö° All ACTIVE others draw +1 & Reverse</span>`;
            triggerTeidenFX(pIndex);
            
            players.forEach((p, i) => {
                if(i !== pIndex && p.status === 'active') {
                    if(deck.length > 0) p.hand.push(deck.pop());
                }
            });
            
            direction *= -1;
            updateDirectionIcon();
        }
        
        log(logMsg);
        
        if(gameOver) return; 

        // Check Elimination
        if(player.hand.length === 0) {
            player.status = 'eliminated';
            log(`<span class="log-elim">üö´ ${player.name} has 0 cards and DROPS OUT!</span>`);
            
            let active = players.filter(p => p.status === 'active');
            if(active.length === 1) {
                let survivor = players.find(p => p.status === 'active');
                let sIndex = players.indexOf(survivor);
                log(`<span class="log-win">üèÜ Only ${survivor.name} remains! SURVIVAL WIN!</span>`);
                gameOver = true;
                showRanking(sIndex); 
                return;
            }
        }
    }
    
    updateStatusDisplay();
    
    if(!gameOver) {
        advanceTurn();
    }
}

function advanceTurn() {
    turnCount++;
    turnIndex = (turnIndex + direction) % 4;
    if(turnIndex < 0) turnIndex += 4;
}

function checkLastHit(lc, pIndex) {
    const total = 10;
    let filled = 0;
    for(let i=1; i<=10; i++) {
        if(mapState[`${lc}-${i}`] !== undefined) filled++;
    }
    
    if(filled === total && lastHits[lc] === undefined) {
        lastHits[lc] = pIndex;
        players[pIndex].guno++;
        players[pIndex].completed.push(lc);
        log(`<span class="log-win">üèÜ ${players[pIndex].name} completes ${lc}! (1 GUNO)</span>`);
        checkWinCondition(pIndex);
    }
}

function checkWinCondition(pIndex) {
    if(players[pIndex].guno >= 4) {
        log(`<span class="log-win">üéâüéâüéâ ${players[pIndex].name} DECLARES 4GUNO! WINNER! üéâüéâüéâ</span>`);
        gameOver = true;
        showRanking(pIndex);
    }
}

function endGameByScore() {
    gameOver = true;
    log(`Game Over (Deck Empty / No Moves). Calculating Scores...`);
    showRanking(null);
}

// --- Ranking Logic v43 (Prioritize Survival) ---
function showRanking(instantWinnerIndex) {
    let rankingData = players.map((p, i) => {
        let handSum = p.hand.reduce((acc, c) => acc + (c.order || 0), 0);
        return {
            index: i,
            name: p.name,
            guno: p.guno,
            handSum: handSum,
            status: p.status,
            isInstantWinner: (i === instantWinnerIndex)
        };
    });

    rankingData.sort((a, b) => {
        // 1. Instant Win Flag
        if(a.isInstantWinner) return -1;
        if(b.isInstantWinner) return 1;
        
        // 2. Active > Eliminated (‚òÖFIX)
        const aActive = (a.status === 'active');
        const bActive = (b.status === 'active');
        if (aActive && !bActive) return -1;
        if (!aActive && bActive) return 1;

        // 3. GUNO Count
        if (b.guno !== a.guno) return b.guno - a.guno; 
        
        // 4. Hand Sum
        return a.handSum - b.handSum; 
    });

    const tbody = document.getElementById('ranking-body');
    let html = "";
    rankingData.forEach((d, idx) => {
        let rank = idx + 1;
        let rowColor = (rank===1) ? "gold" : "white";
        if(d.isInstantWinner) rowColor = "#ff44ff";

        html += `<tr style="color:${rowColor}">
            <td>${rank}</td>
            <td>${d.name}</td>
            <td>${d.guno}</td>
            <td>${d.handSum}</td>
            <td>${d.status}</td>
        </tr>`;
    });
    tbody.innerHTML = html;
    document.getElementById('result-area').style.display = "block";
}

// --- Visuals & FX ---

function triggerTeidenFX(sourceIndex) {
    const fx = document.getElementById('fx-layer');
    fx.style.display = 'block';
    fx.innerHTML = '<div class="flash" style="width:100%;height:100%"></div>';
    
    const panels = document.querySelectorAll('.panel');
    panels.forEach(p => p.classList.add('darken'));

    setTimeout(() => {
        fx.innerHTML = '';
        panels.forEach(p => p.classList.remove('darken'));
        fx.style.display = 'none';
        
        players.forEach((p, i) => {
            if(i !== sourceIndex && p.status === 'active') {
                showPopup(i, "+1");
            }
        });
    }, 250);
}

function showPopup(playerIndex, text) {
    const pDiv = document.getElementById(`p-box-${playerIndex}`);
    if(!pDiv) return;
    const rect = pDiv.getBoundingClientRect();
    
    const pop = document.createElement('div');
    pop.className = 'popup-text';
    pop.textContent = text;
    pop.style.left = (rect.left + rect.width/2) + 'px';
    pop.style.top = rect.top + 'px';
    document.body.appendChild(pop);
    
    setTimeout(() => pop.remove(), 1000);
}

function updateDirectionIcon() {
    document.getElementById('turn-direction').textContent = direction === 1 ? "‚Üª" : "‚Ü∫";
}

function updateStatusDisplay() {
    let activeCnt = players.filter(p=>p.status==='active').length;
    document.getElementById('status-display').textContent = `Turn: ${turnCount} | Active: ${activeCnt}`;
}

function renderAll() {
    renderLog();
    renderDiscard();
    renderMap();
    renderPlayers();
    document.getElementById('guno-count').textContent = Object.keys(lastHits).length;
    
    // Update Draw Pile
    const deckDiv = document.getElementById('draw-pile-visual');
    deckDiv.textContent = deck.length;
    if(deck.length === 0) {
        deckDiv.style.opacity = 0.3;
        deckDiv.style.backgroundColor = '#333';
        deckDiv.style.backgroundImage = 'none';
    } else {
        deckDiv.style.opacity = 1.0;
        deckDiv.style.backgroundColor = '#444';
        deckDiv.style.backgroundImage = "url('https://geodo.earth/guno-map/cards/GUNO_BACK.png')";
    }
}

function renderLog() {
    const el = document.getElementById('log');
    el.scrollTop = el.scrollHeight;
}

function renderDiscard() {
    const el = document.getElementById('discard-pile');
    if(discardPile.length === 0) {
        el.innerHTML = "Empty";
        return;
    }
    const top = discardPile[discardPile.length - 1];
    el.innerHTML = createCardHTML(top);
}

function renderMap() {
    ['JY', 'M', 'G', 'T'].forEach(lc => {
        const div = document.getElementById(`map-${lc.toLowerCase()}`);
        let html = "";
        const stations = STATIONS_DB.filter(s => s.lc === lc).sort((a,b)=>a.order-b.order);
        
        stations.forEach(s => {
            const key = `${lc}-${s.order}`;
            const owner = mapState[key];
            let classes = "slot";
            let content = `<div>${s.order}</div><div>${s.st_ja}</div>`;
            
            if(owner !== undefined) {
                classes += " active";
                content = `<div style="color:${s.color}; font-weight:bold;">${s.st_ja}</div><div style="font-size:9px">${s.st_en}</div>`;
            }
            if(lastHits[lc] !== undefined) classes += " completed";
            html += `<div class="${classes}" style="border-color:${s.color}">${content}</div>`;
        });
        div.innerHTML = html;
    });
}

function renderPlayers() {
    const div = document.getElementById('players-area');
    let html = "";
    players.forEach((p, i) => {
        let isTurn = (i === turnIndex && !gameOver && p.status === 'active');
        let boxClass = `player-box ${isTurn ? 'active-turn' : ''} ${p.status === 'eliminated' ? 'eliminated' : ''}`;
        
        let cardsHtml = p.hand.map(c => createCardHTML(c, true)).join('');
        let badges = p.completed.map(lc => `<span style="background:gold;color:black;padding:2px;border-radius:4px;margin-left:5px;">${lc}</span>`).join('');
        
        html += `
        <div id="p-box-${i}" class="${boxClass}">
            <div class="player-stats">
                <span>${p.name} ${badges} <span class="dropout-badge">DROPOUT</span></span>
                <span>GUNO: ${p.guno}</span>
            </div>
            <div class="hand" style="font-size:12px; min-height:40px;">
                ${cardsHtml} (Total: ${p.hand.length})
            </div>
        </div>`;
    });
    div.innerHTML = html;
}

function createCardHTML(card, small=false) {
    let url = `${IMAGE_BASE_URL}${card.file}.png`;
    let style = `background-image: url('${url}');`;
    if(small) {
        style += "width:30px; height:45px; border-width:1px;";
    }
    let typeClass = card.lc ? card.lc.toLowerCase() : 'teiden';
    if(card.type === 'teiden') typeClass = 'teiden';
    return `<div class="card ${typeClass}" style="${style}" title="${card.ja || 'TEIDEN'}"></div>`;
}

function cardStr(c) {
    if(c.type === 'teiden') return `[‚ö°TEIDEN ${c.lc}]`;
    return `[${c.lc} ${c.ja}]`;
}

function log(msg) {
    document.getElementById('log').innerHTML += `<div style="margin-bottom:2px;">${msg}</div>`;
}
function logTurn(msg) {
    document.getElementById('log').innerHTML += `<div class="log-turn">${msg}</div>`;
}

// Auto Play
function toggleAuto() {
    autoPlay = !autoPlay;
    document.getElementById('btn-auto').classList.toggle('active', autoPlay);
    if(autoPlay) {
        if(gameOver) startGame(); 
        autoLoop();
    } else {
        stopAuto();
    }
}
function stopAuto() {
    autoPlay = false;
    clearTimeout(autoTimer);
    document.getElementById('btn-auto').classList.remove('active');
}
function autoLoop() {
    if(!autoPlay || gameOver) return;
    step();
    let speed = document.getElementById('speed-range').value;
    autoTimer = setTimeout(autoLoop, speed);
}

// Initial
document.getElementById('log').innerHTML = "Ready. Press New Game.";

</script>
</body>
</html>