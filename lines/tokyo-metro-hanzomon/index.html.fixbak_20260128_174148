<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>東京メトロ半蔵門線｜ジオ道</title>
  <meta name="description" content="東京メトロ半蔵門線（渋谷〜押上）の鉄道史と路線データ（ジオ道）。" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; line-height:1.8; }
    main { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    #map { height: 520px; border-radius: 14px; overflow: hidden;
           box-shadow: 0 8px 30px rgba(0,0,0,.10); margin-bottom: 24px; }
    code { background:#f4f4f6; padding:2px 6px; border-radius:6px; }
    .muted { color:#666; font-size:.95em; }
    h1, h2 { margin-top: 1.6em; }
    ol { padding-left: 1.3em; }
    .station-link { cursor: pointer; text-decoration: underline; }
  </style>
</head>

<body>
<main>
  <p><a href="../">← 路線一覧へ</a></p>

  <h1>東京メトロ半蔵門線</h1>

  <p>
    東京メトロ半蔵門線は <strong>渋谷〜押上</strong> を結ぶ都心横断路線。
    表参道・永田町・大手町・錦糸町など主要結節点を通過する。
  </p>

  <h2>路線（試作データ）</h2>
  <div id="map"></div>
  <p class="muted">
    中心線（上下2ライン）＋駅ポイント（1駅1点）を表示。
    line_slug: <code>tokyo-metro-hanzomon</code>
  </p>

  <h2>駅一覧（渋谷 → 押上）</h2>
  <div id="station-list"><p>読み込み中...</p></div>
</main>

<script>
const LINE_GEOJSON_URL = "../../assets/geojson/lines/tokyo-metro-hanzomon.geojson";
const STATIONS_GEOJSON_URL = "../../assets/geojson/stations/tokyo-metro-hanzomon_stations.geojson";
const LINE_COLOR = "#8F76D6";

// map init
const map = L.map("map", { zoomControl: true });

// panes (★重要)
map.createPane("linesPane");
map.getPane("linesPane").style.zIndex = 400;

map.createPane("stationsPane");
map.getPane("stationsPane").style.zIndex = 650;

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

const boundsLayers = L.featureGroup().addTo(map);
const stationMarkerById = new Map();

function stationName(p) {
  return p.station_name_ja || p.name_ja || p["name:ja"] || p.name || p.name_en || "(no name)";
}
function stationId(p) { return String(p.station_id || p.id || ""); }
function stationOrder(p) {
  const v = p.station_order ?? p.order ?? p.seq ?? p.station_seq;
  const n = Number(v);
  return Number.isFinite(n) ? n : 9999;
}

// line
fetch(LINE_GEOJSON_URL, { cache:"no-store" })
  .then(r => r.json())
  .then(gj => {
    const lineLayer = L.geoJSON(gj, {
      pane: "linesPane",
      style: { color: LINE_COLOR, weight: 5, opacity: 0.92 }
    }).addTo(map);

    boundsLayers.addLayer(lineLayer);
    map.fitBounds(lineLayer.getBounds(), { padding:[20,20] });
  });

// stations
fetch(STATIONS_GEOJSON_URL, { cache:"no-store" })
  .then(r => r.json())
  .then(stationData => {
    const feats = (stationData.features || [])
      .filter(f => f.geometry && f.geometry.type==="Point")
      .sort((a,b)=>stationOrder(a.properties)-stationOrder(b.properties));

    const stationLayer = L.geoJSON(
      { type:"FeatureCollection", features:feats },
      {
        pane: "stationsPane",
        pointToLayer: (feature, latlng) => {
          const m = L.circleMarker(latlng, {
            pane:"stationsPane",
            radius:6,
            color:LINE_COLOR,
            weight:2,
            fillColor:"#f6f2ff",
            fillOpacity:0.95
          });
          const sid = stationId(feature.properties||{});
          if (sid) stationMarkerById.set(sid, m);
          return m;
        },
        onEachFeature: (feature, layer) => {
          const p = feature.properties||{};
          layer.bindPopup(
            `<strong>${stationName(p)}</strong><br>` +
            `駅順: ${stationOrder(p)}<br>` +
            (p.station_id ? `ID: ${p.station_id}` : "")
          );
        }
      }
    ).addTo(map);

    boundsLayers.addLayer(stationLayer);

    // list
    const list = document.getElementById("station-list");
    const ol = document.createElement("ol");
    feats.forEach(f=>{
      const p=f.properties||{};
      const li=document.createElement("li");
      const a=document.createElement("span");
      a.className="station-link";
      a.textContent = `${stationName(p)}（#${stationOrder(p)}）`;
      a.onclick=()=>{
        const m=stationMarkerById.get(stationId(p));
        if(m){ map.setView(m.getLatLng(), Math.max(map.getZoom(),15)); m.openPopup(); }
      };
      li.appendChild(a); ol.appendChild(li);
    });
    list.innerHTML=""; list.appendChild(ol);
  });
</script>
</body>
</html>
