<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>東京メトロ東西線 | ジオ道</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    header { padding: 18px 16px 10px; border-bottom: 1px solid #eee; }
    header h1 { margin: 0 0 6px; font-size: 22px; }
    header .meta { color: #555; font-size: 13px; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 0 16px 28px; }
    .nav { margin: 12px 0 0; }
    .nav a { text-decoration: none; }
    #map { height: 64vh; min-height: 420px; border-radius: 12px; overflow: hidden; margin: 14px 0 18px; border: 1px solid #eee; }
    h2 { margin: 26px 0 10px; font-size: 18px; }
    p { line-height: 1.7; }
    ul { line-height: 1.8; }
    .note { font-size: 13px; color: #666; }
    .badge { display:inline-block; padding:2px 10px; border-radius: 999px; background:#f2f2f2; font-size: 12px; margin-left: 8px; vertical-align: middle; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 980px){
      .grid { grid-template-columns: 1.3fr 0.7fr; }
      #map { height: 72vh; }
    }
    .card { border:1px solid #eee; border-radius:12px; padding:14px; }
    .small { font-size: 13px; color:#555; }
    code { background:#f7f7f7; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="nav"><a href="/lines/">← 路線一覧へ</a></div>
      <h1>東京メトロ東西線 <span class="badge">現代</span></h1>
      <div class="meta">Geo道（geodo.earth） / LineString＋駅ポイント（station_order付き）</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section>
        <div id="map"></div>
        <div class="note">
          ※ 線路データはOSMの線路wayを反映しているため、区間によって複線（2本）や配線（最大4本）として表示されます（仕様）。
        </div>

        <h2>鉄道史</h2>
        <p>
          東西線は、戦後の都市拡大と通勤輸送の逼迫を背景に、都心を東西に貫く幹線として整備された路線です。
          大手町・日本橋など都心業務地と、江東区・浦安方面の住宅地、さらにJR総武線方面との結節を担い、
          「都心横断＋郊外接続」を同時に成立させる役割を担ってきました。
          現在は東側でJR総武線（西船橋接続）と連携し、東京の東西移動の骨格の一つになっています。
        </p>

        <h2>年表（概略）</h2>
        <ul>
          <li>計画：戦後の通勤輸送対策として、都心東西貫通の地下鉄整備が構想される</li>
          <li>建設：都心（大手町周辺）〜東側（江東区方面）を段階的に延伸</li>
          <li>接続：西船橋でJR線（総武線方面）との結節により、広域通勤動線として定着</li>
          <li>現在：都心業務地と東部住宅地をつなぐ通勤幹線として高頻度運行</li>
        </ul>

        <p class="small">
          ※ 正確な開業年・延伸年表は、今後「歴史レイヤー（開業区間別GeoJSON）」を追加して精密化していきます。
        </p>
      </section>

      <aside class="card">
        <h2>表示内容</h2>
        <ul class="small">
          <li><b>路線</b>：<code>assets/geojson/lines/tokyo-metro-tozai.geojson</code></li>
          <li><b>駅</b>：<code>assets/geojson/stations/tokyo-metro-tozai_stations.geojson</code></li>
          <li><b>駅順</b>：西船橋→中野（<code>station_order</code>）</li>
          <li><b>route_id</b>：403（<code>route_id</code>）</li>
          <li><b>line_slug</b>：tokyo-metro-tozai</li>
        </ul>

        <h2>次の拡張</h2>
        <ul class="small">
          <li>歴史化：開業区間ごとの年次GeoJSON（例：1964/1966…）</li>
          <li>駅：開業年・改称・乗換の注記（ポップアップ拡張）</li>
          <li>GUNO：簡略中心線（盤面向け）と史実版（研究向け）の二系統</li>
        </ul>
      </aside>
    </div>
  </main>

  <script>
    // ===== data URLs =====
    const LINE_GEOJSON_URL = "../../assets/geojson/lines/tokyo-metro-tozai.geojson";
    const STATIONS_GEOJSON_URL = "../../assets/geojson/stations/tokyo-metro-tozai_stations.geojson";

    // ===== map init =====
    const map = L.map("map", { zoomControl: true });

    // OSM tile
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const lineLayer = L.geoJSON(null, {
      style: () => ({
        // 色は一旦デフォルト（あなたの方針）
        weight: 5,
        opacity: 0.95
      })
    }).addTo(map);

    const stationLayer = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => {
        // 見やすさ優先で白縁
        return L.circleMarker(latlng, {
          radius: 6,
          weight: 2,
          opacity: 1,
          fillOpacity: 0.95
        });
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const name = p.name || p["name:ja"] || "(no name)";
        const order = p.station_order ?? "";
        const routeId = p.route_id ?? "";
        const slug = p.line_slug ?? "";

        const rows = [
          `<tr><th style="text-align:left;padding:2px 10px 2px 0;">駅名</th><td>${escapeHtml(name)}</td></tr>`,
          `<tr><th style="text-align:left;padding:2px 10px 2px 0;">順序</th><td>${escapeHtml(String(order))}</td></tr>`,
          `<tr><th style="text-align:left;padding:2px 10px 2px 0;">route_id</th><td>${escapeHtml(String(routeId))}</td></tr>`,
          `<tr><th style="text-align:left;padding:2px 10px 2px 0;">line_slug</th><td>${escapeHtml(String(slug))}</td></tr>`
        ].join("");

        layer.bindPopup(`
          <div style="min-width:220px">
            <div style="font-weight:700;margin-bottom:6px;">${escapeHtml(name)}</div>
            <table style="font-size:13px;line-height:1.4">${rows}</table>
          </div>
        `);
      }
    }).addTo(map);

    // ===== load geojson =====
    Promise.all([
      fetch(LINE_GEOJSON_URL).then(r => r.json()),
      fetch(STATIONS_GEOJSON_URL).then(r => r.json())
    ]).then(([lineGj, stGj]) => {
      lineLayer.addData(lineGj);
      stationLayer.addData(stGj);

      // fit bounds to line (fallback to stations)
      const b1 = lineLayer.getBounds();
      if (b1 && b1.isValid()) {
        map.fitBounds(b1.pad(0.12));
      } else {
        const b2 = stationLayer.getBounds();
        if (b2 && b2.isValid()) map.fitBounds(b2.pad(0.2));
      }
    }).catch(err => {
      console.error(err);
      alert("GeoJSONの読み込みに失敗しました。パスとファイル配置を確認してください。");
    });

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
  </script>
</body>
</html>
