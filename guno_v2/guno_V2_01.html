<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>GUNO v2.0 (GIS Integration Alpha)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* --- 1. v44 Original Styles (Base) --- */
    :root { --bg-color: #222; --text-color: #eee; }
    body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; font-size: 14px; overflow: hidden; }
    .header { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 10px; margin-bottom: 10px; }
    .game-container { display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; height: calc(100vh - 100px); }
    .panel { background: #333; padding: 10px; border-radius: 8px; overflow-y: auto; display: flex; flex-direction: column; }
    
    /* Map Container */
    #map { flex-grow: 1; min-height: 400px; border-radius: 4px; background: #111; }

    /* --- 2. NotebookLM Visual Effects --- */
    /* ÂÅúÈõª„É¢„Éº„ÉâÔºöÂú∞Âõ≥ÂÖ®‰Ωì„ÇíÊöó„Åè„Åó„ÄÅËâ≤Áõ∏„Çí„Åö„Çâ„Åô */
    .teiden-mode .leaflet-tile-pane {
        filter: brightness(30%) sepia(100%) hue-rotate(-50deg) saturate(500%);
        transition: filter 0.5s ease;
    }
    /* Âà∂ÂúßË∑ØÁ∑ö„ÅÆËÑàÂãï„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes widthPulse {
        0% { stroke-width: 6; stroke-opacity: 1; }
        50% { stroke-width: 10; stroke-opacity: 0.7; }
        100% { stroke-width: 6; stroke-opacity: 1; }
    }
    .pulse-animation path {
        animation: widthPulse 2s infinite ease-in-out;
        stroke-linecap: round;
    }

    /* --- 3. Card & UI Styles --- */
    .card { width: 50px; height: 75px; background: #fff; border: 2px solid #ccc; display: inline-block; margin: 2px; background-size: contain; background-repeat: no-repeat; background-position: center; }
    .card.jy { border-color: #00AA00; } .card.m { border-color: #F62E36; } 
    .card.g { border-color: #FF9500; } .card.t { border-color: #009BBF; }
    .card.teiden { border-color: #000; box-shadow: 0 0 5px #fff; }
    
    .player-box { padding: 5px; margin-bottom: 5px; border: 1px solid #555; }
    .player-box.active-turn { background: #444; border-color: #fff; }
    .log-turn { border-bottom: 1px solid #444; color: #aaa; margin-top: 5px; }
    .log-play { color: #88ff88; } .log-teiden { color: #ffff00; font-weight: bold; }
</style>
</head>
<body>

<div class="header">
    <div>
        <h2>GUNO v2.0 (GIS Alpha)</h2>
        <small>v44 Logic + Leaflet Map Integration</small>
    </div>
    <div>
        <span id="turn-direction">‚Üª</span>
        <button onclick="startGame()">üé≤ New Game</button>
        <button onclick="step()">Step</button>
        <button onclick="toggleAuto()">‚ñ∂ Auto</button>
    </div>
</div>

<div class="game-container">
    <div class="panel">
        <h3>Game Log</h3>
        <div id="status-display">Turn: 0</div>
        <div id="log" style="flex-grow:1; overflow-y:auto;"></div>
    </div>

    <div class="panel">
        <h3>Shared Map (Tokyo GIS)</h3>
        <div style="display:flex; gap:20px; margin-bottom:10px; justify-content: center;">
            <div>Deck: <span id="deck-count">84</span></div>
            <div id="discard-pile"></div>
        </div>
        <div id="map"></div>
    </div>

    <div class="panel">
        <h3>Players</h3>
        <div id="players-area"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================================
   1. GUNO CONFIGURATION
   ========================================= */
const IMAGE_BASE_URL = "https://geodo.earth/guno_v2/cards/";

const GUNO_CONFIG = {
    lines: {
        "JY": { slug: "jr-east-yamanote", color: "#00AA00", status: "active" },
        "M":  { slug: "tokyo-metro-marunouchi", color: "#F62E36", status: "active" },
        "G":  { slug: "tokyo-metro-ginza", color: "#FF9500", status: "active" },
        "T":  { slug: "tokyo-metro-tozai", color: "#009BBF", status: "active" },
        // „Çπ„Éà„É¨„ÉÉ„ÉÅ„Ç¥„Éº„É´Áî®ÔºàÊú™Ëß£ÊîæÔºâ
        "Y":  { slug: "tokyo-metro-yurakucho", color: "#C1A470", status: "locked" },
        "Z":  { slug: "tokyo-metro-hanzomon", color: "#8F76D6", status: "locked" },
        "N":  { slug: "tokyo-metro-namboku", color: "#00AC9B", status: "locked" }
    },
    playerColors: ["#FF3333", "#3388FF", "#33FF33", "#FFFF33"]
};

// Map Global Variables
let map;
let geoJsonLayers = {}; 

/* =========================================
   2. MAP INITIALIZATION & LOADING
   ========================================= */
function initMap() {
    // Êù±‰∫¨ÈßÖ„Çí‰∏≠ÂøÉ„Å´Ë®≠ÂÆö
    map = L.map('map').setView([35.681236, 139.767125], 12);
    
    // ËÉåÊôØÂú∞Âõ≥ (CartoDB DarkMatter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // GeoJSONË™≠„ÅøËæº„Åø (Á∑ö„Å®ÈßÖ)
    Object.values(GUNO_CONFIG.lines).forEach(lineConfig => {
        loadLineData(lineConfig);
        loadStationData(lineConfig); // ÈßÖ„Éá„Éº„Çø„ÇÇË™≠„ÅøËæº„ÇÄ
    });
}

function loadLineData(config) {
    const url = `./geojson/lines/${config.slug}.geojson`; 
    fetch(url)
        .then(res => res.json())
        .then(data => {
            const layer = L.geoJSON(data, {
                style: { color: config.color, weight: 4, opacity: 0.5 }
            }).addTo(map);
            geoJsonLayers[config.slug] = layer;
            resetLineStyle(config.slug);
        })
        .catch(err => console.log(`Line data not found: ${config.slug}`));
}

function loadStationData(config) {
    const url = `./geojson/stations/${config.slug}_stations.geojson`;
    fetch(url)
        .then(res => res.json())
        .then(data => {
            L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 4,
                        fillColor: "#ffffff",
                        color: config.color,
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 1
                    });
                },
                onEachFeature: function (feature, layer) {
                    if (feature.properties && feature.properties.name) {
                        layer.bindPopup(`<b>${feature.properties.name}</b><br>${config.slug}`);
                    }
                }
            }).addTo(map);
        })
        .catch(err => console.log(`Station data skipped: ${config.slug}`));
}

/* =========================================
   3. ADAPTER FUNCTIONS
   ========================================= */
function updateMapFromLogic(gameState) {
    // 1. ÂêÑË∑ØÁ∑ö„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
    Object.keys(GUNO_CONFIG.lines).forEach(logicId => {
        const config = GUNO_CONFIG.lines[logicId];
        const layer = geoJsonLayers[config.slug];
        if (!layer) return;

        let style = { color: config.color, weight: 4, opacity: 0.6, dashArray: null };

        // A. Êú™Ëß£Êîæ (Locked)
        if (config.status === "locked") {
            style.color = "#444"; 
            style.weight = 2;
            style.opacity = 0.3;
            style.dashArray = "5, 10"; 
        } 
        // B. Ëß£ÊîæÊ∏à„Åø (Active)
        else {
            // Âà∂ÂúßÊ∏à„Åø (Completed)
            if (gameState.lastHits[logicId] !== undefined) {
                const ownerIndex = gameState.lastHits[logicId];
                style.color = GUNO_CONFIG.playerColors[ownerIndex];
                style.weight = 8;
                style.opacity = 1.0;
                style.className = "pulse-animation"; 
            }
            // ÈÄ≤Ë°å‰∏≠ (Touched)
            else if (gameState.touchedLines[logicId]) {
                style.weight = 6;
                style.opacity = 0.9;
                style.className = "";
            } else {
                style.className = ""; 
            }
        }

        layer.setStyle(style);
        
        if (layer.eachLayer) {
            layer.eachLayer(l => {
                if (l.getElement()) {
                    l.getElement().classList.remove('pulse-animation');
                    if (style.className) l.getElement().classList.add(style.className);
                }
            });
        }
    });

    // 2. ÂÅúÈõª„Ç®„Éï„Çß„ÇØ„Éà
    const mapContainer = document.getElementById('map');
    if (gameState.isTeidenActive) {
        mapContainer.classList.add('teiden-mode');
    } else {
        mapContainer.classList.remove('teiden-mode');
    }
}

function resetLineStyle(slug) {
    updateMapFromLogic({ lastHits: {}, touchedLines: {}, isTeidenActive: false });
}

/* =========================================
   4. GAME LOGIC & DATA
   ========================================= */
// --- Master Data (Station List) ---
const STATIONS_DB = [
    // --- JR Yamanote (JY) ---
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:1, st_ja:'Êù±‰∫¨', st_en:'Tokyo', color:'#00AA00', file:'JY_01_Tokyo'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:2, st_ja:'ÊúâÊ•ΩÁî∫', st_en:'Yurakucho', color:'#00AA00', file:'JY_02_Yurakucho'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:3, st_ja:'Êñ∞Ê©ã', st_en:'Shimbashi', color:'#00AA00', file:'JY_03_Shimbashi'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:4, st_ja:'ÂìÅÂ∑ù', st_en:'Shinagawa', color:'#00AA00', file:'JY_04_Shinagawa'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:5, st_ja:'Ê∏ãË∞∑', st_en:'Shibuya', color:'#00AA00', file:'JY_05_Shibuya'}, 
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:6, st_ja:'Êñ∞ÂÆø', st_en:'Shinjuku', color:'#00AA00', file:'JY_06_Shinjuku'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:7, st_ja:'È´òÁî∞È¶¨Â†¥', st_en:'Takadanobaba', color:'#00AA00', file:'JY_07_Takadanobaba'}, 
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:8, st_ja:'Ê±†Ë¢ã', st_en:'Ikebukuro', color:'#00AA00', file:'JY_08_Ikebukuro'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:9, st_ja:'‰∏äÈáé', st_en:'Ueno', color:'#00AA00', file:'JY_09_Ueno'},
    {lc:'JY', name:'Â±±ÊâãÁ∑ö', order:10, st_ja:'ÁßãËëâÂéü', st_en:'Akihabara', color:'#00AA00', file:'JY_10_Akihabara'},

    // --- Marunouchi (M) ---
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:1, st_ja:'Ê±†Ë¢ã', st_en:'Ikebukuro', color:'#F62E36', file:'M_01_Ikebukuro'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:2, st_ja:'ËåóËç∑Ë∞∑', st_en:'Myogadani', color:'#F62E36', file:'M_02_Myogadani'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:3, st_ja:'ÂæåÊ•ΩÂúí', st_en:'Korakuen', color:'#F62E36', file:'M_03_Korakuen'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:4, st_ja:'Âæ°Ëå∂„ÉéÊ∞¥', st_en:'Ochanomizu', color:'#F62E36', file:'M_04_Ochanomizu'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:5, st_ja:'Êù±‰∫¨', st_en:'Tokyo', color:'#F62E36', file:'M_05_Tokyo'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:6, st_ja:'ÈäÄÂ∫ß', st_en:'Ginza', color:'#F62E36', file:'M_06_Ginza'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:7, st_ja:'Ëµ§ÂùÇË¶ãÈôÑ', st_en:'Akasaka-mitsuke', color:'#F62E36', file:'M_07_Akasaka-mitsuke'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:8, st_ja:'Âõõ„ÉÑË∞∑', st_en:'Yotsuya', color:'#F62E36', file:'M_08_Yotsuya'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:9, st_ja:'Êñ∞ÂÆø', st_en:'Shinjuku', color:'#F62E36', file:'M_09_Shinjuku'},
    {lc:'M', name:'‰∏∏„ÉéÂÜÖÁ∑ö', order:10, st_ja:'‰∏≠ÈáéÂùÇ‰∏ä', st_en:'Nakano-sakaue', color:'#F62E36', file:'M_10_Nakano-sakaue'},

    // --- Ginza (G) ---
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:1, st_ja:'Ê∏ãË∞∑', st_en:'Shibuya', color:'#FF9500', file:'G_01_Shibuya'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:2, st_ja:'Ë°®ÂèÇÈÅì', st_en:'Omotesando', color:'#FF9500', file:'G_02_Omotesando'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:3, st_ja:'ÈùíÂ±±‰∏Ä‰∏ÅÁõÆ', st_en:'Aoyama-itchome', color:'#FF9500', file:'G_03_Aoyama-itchome'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:4, st_ja:'Ëµ§ÂùÇË¶ãÈôÑ', st_en:'Akasaka-mitsuke', color:'#FF9500', file:'G_04_Akasaka-mitsuke'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:5, st_ja:'Ê∫úÊ±†Â±±Áéã', st_en:'Tameike-sanno', color:'#FF9500', file:'G_05_Tameike-sanno'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:6, st_ja:'Êñ∞Ê©ã', st_en:'Shimbashi', color:'#FF9500', file:'G_06_Shimbashi'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:7, st_ja:'ÈäÄÂ∫ß', st_en:'Ginza', color:'#FF9500', file:'G_07_Ginza'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:8, st_ja:'‰∏äÈáé', st_en:'Ueno', color:'#FF9500', file:'G_08_Ueno'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:9, st_ja:'Á®≤Ëç∑Áî∫', st_en:'Inaricho', color:'#FF9500', file:'G_09_Inaricho'},
    {lc:'G', name:'ÈäÄÂ∫ßÁ∑ö', order:10, st_ja:'ÊµÖËçâ', st_en:'Asakusa', color:'#FF9500', file:'G_10_Asakusa'},

    // --- Tozai (T) ---
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:1, st_ja:'‰∏≠Èáé', st_en:'Nakano', color:'#009BBF', file:'T_01_Nakano'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:2, st_ja:'ËêΩÂêà', st_en:'Ochiai', color:'#009BBF', file:'T_02_Ochiai'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:3, st_ja:'È´òÁî∞È¶¨Â†¥', st_en:'Takadanobaba', color:'#009BBF', file:'T_03_Takadanobaba'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:4, st_ja:'Êó©Á®≤Áî∞', st_en:'Waseda', color:'#009BBF', file:'T_04_Waseda'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:5, st_ja:'È£ØÁî∞Ê©ã', st_en:'Iidabashi', color:'#009BBF', file:'T_05_Iidabashi'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:6, st_ja:'Â§ßÊâãÁî∫', st_en:'Otemachi', color:'#009BBF', file:'T_06_Otemachi'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:7, st_ja:'Êó•Êú¨Ê©ã', st_en:'Nihombashi', color:'#009BBF', file:'T_07_Nihombashi'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:8, st_ja:'ËåÖÂ†¥Áî∫', st_en:'Kayabacho', color:'#009BBF', file:'T_08_Kayabacho'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:9, st_ja:'ÈñÄÂâç‰ª≤Áî∫', st_en:'Monzen-nakacho', color:'#009BBF', file:'T_09_Monzen-nakacho'},
    {lc:'T', name:'Êù±Ë•øÁ∑ö', order:10, st_ja:'Êù±ÈôΩÁî∫', st_en:'Toyocho', color:'#009BBF', file:'T_10_Toyocho'}
]; // ‚òÖ„Åì„Åì„ÅåÈáçË¶Å„Åß„ÅôÔºÅ

// Game Variables
let deck = [], players = [], discardPile = [];
let mapState = {}, lastHits = {}, gameOver = false;
let turnIndex = 0, autoTimer = null;

function initDeck() {
    deck = [];
    STATIONS_DB.forEach(s => {
        deck.push({type:'station', ...s});
        deck.push({type:'station', ...s}); // 2Êûö„Åö„Å§
    });
    // Teiden
    ['JY','M','G','T'].forEach(lc => deck.push({type:'teiden', lc:lc, color:'#000'}));
    deck.sort(() => Math.random() - 0.5);
}

function startGame() {
    players = [
        {name:"P1", hand:[], guno:0}, {name:"P2", hand:[], guno:0},
        {name:"P3", hand:[], guno:0}, {name:"P4", hand:[], guno:0}
    ];
    mapState = {}; lastHits = {}; discardPile = [];
    initDeck();
    
    players.forEach(p => { for(let i=0; i<5; i++) p.hand.push(deck.pop()); });
    discardPile.push(deck.pop());

    document.getElementById('log').innerHTML = "Game Start!";
    renderAll();
}

function step() {
    if(gameOver) return;
    const p = players[turnIndex];
    const card = p.hand.pop(); 
    if(card) {
        discardPile.push(card);
        log(`${p.name} plays ${card.lc || 'TEIDEN'}`);
        if(card.type === 'station') {
            const key = `${card.lc}-${card.order}`;
            mapState[key] = turnIndex;
            if(!lastHits[card.lc] && Math.random() > 0.8) { 
                lastHits[card.lc] = turnIndex;
                log(`üèÜ ${p.name} completes ${card.lc}!`);
            }
        }
    } else {
        if(deck.length) p.hand.push(deck.pop());
    }
    
    turnIndex = (turnIndex + 1) % 4;
    renderAll();
}

function log(msg) {
    const d = document.getElementById('log');
    d.innerHTML += `<div>${msg}</div>`;
    d.scrollTop = d.scrollHeight;
}

function toggleAuto() {
    if(autoTimer) { clearInterval(autoTimer); autoTimer=null; }
    else { autoTimer = setInterval(step, 200); }
}

function renderAll() {
    document.getElementById('deck-count').innerText = deck.length;
    const pDiv = document.getElementById('players-area');
    pDiv.innerHTML = players.map((p,i) => 
        `<div class="player-box ${i===turnIndex?'active-turn':''}">
            ${p.name} (Cards: ${p.hand.length})
         </div>`
    ).join('');

    const top = discardPile[discardPile.length-1];
    const bg = top ? `url('${IMAGE_BASE_URL}${top.file || 'TEIDEN_CARD'}.png')` : 'none';
    
    document.getElementById('discard-pile').innerHTML = top 
        ? `<div class="card ${top.lc?top.lc.toLowerCase():'teiden'}" style="border-color:${top.color}; background-image:${bg}"></div>` 
        : 'Empty';

    renderMapAdapter();
}

function renderMapAdapter() {
    const touched = {};
    Object.keys(mapState).forEach(key => touched[key.split('-')[0]] = true);
    const top = discardPile[discardPile.length-1];
    const isTeiden = (top && top.type === 'teiden');

    updateMapFromLogic({
        lastHits: lastHits,
        touchedLines: touched,
        isTeidenActive: isTeiden
    });
}

// Ëµ∑ÂãïÊôÇ
window.onload = function() {
    initMap();
    startGame();
};
</script>
</body>
</html>