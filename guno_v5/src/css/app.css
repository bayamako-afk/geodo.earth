/* =========================
   GUNO v5 app.css (Base + Layout unified)
   - カードが必ず見える
   - 3面固定：左 dashboard / 右上 slots / 右下 map
   - HTMLは変更不要（.left-col を display:contents で潰す）
   ========================= */

/* ---------- Theme / Size tokens ---------- */
:root{
  /* line colors */
  --jy-color: #00AA00;
  --m-color:  #F62E36;
  --g-color:  #FF9500;
  --t-color:  #009BBF;

  /* layout */
  --gap: 8px;
  --radius: 10px;
  --left: 0.95fr;
  --right: 1.05fr;
  --right-top: 0.52fr;      /* slots */
  --right-bottom: 0.48fr;   /* map */

  /* cards */
  --card-w: clamp(42px, 4.8vw, 90px);
  --card-h: calc(var(--card-w) * 1.5);
  --card-gap: 8px;

  /* backgrounds (css/app.css -> ../assets/...) */
  --bg-jy: url("../assets/cards/bg_JY.png");
  --bg-m:  url("../assets/cards/bg_M.png");
  --bg-g:  url("../assets/cards/bg_G.png");
  --bg-t:  url("../assets/cards/bg_T.png");
}

/* ---------- Global ---------- */
html, body { height: 100%; }
body{
  font-family: "Helvetica Neue", Arial, sans-serif;
  background:#1a1a1a;
  color:#eee;
  margin:0;
  padding:10px;
  box-sizing:border-box;
  overflow:hidden; /* ページスクロール禁止 */
}
.hidden{ display:none !important; }

/* ---------- Panels ---------- */
.panel{
  background:#222;
  border:1px solid #333;
  padding:10px;
  border-radius: var(--radius);
  min-width:0;
  min-height:0;
  overflow:hidden; /* 固定3面の方針 */
}

/* ---------- 3-pane layout ---------- */
/* HTML:
.game-container
  ├ .left-col
  │   ├ .panel-dashboard
  │   └ .panel-slots
  └ .panel-map
*/
.game-container{
  display:grid;
  grid-template-columns: var(--left) var(--right);
  grid-template-rows: var(--right-top) var(--right-bottom);
  gap: var(--gap);
  height: calc(100dvh - 22px); /* body padding分のざっくり補正（必要なら微調整） */
  min-height:0;
}

/* ★これで .left-col の存在をCSS的に消して再配置できる */
.left-col{ display: contents; }

/* left: dashboard (縦貫通) */
.panel-dashboard{
  grid-column: 1;
  grid-row: 1 / 3;
  display:flex;
  flex-direction: column;
  min-height:0;
}
#players-area{
  flex:1;            /* ★空白を潰す */
  min-height:0;
  overflow:hidden;   /* スクロール出したくない方針 */
}

/* right-top: slots */
.panel-slots{
  grid-column: 2;
  grid-row: 1;
  min-height:0;
  padding:4px;   /* ←10pxなら6pxに */
}
#slots-area{
  display:grid;
  grid-template-columns: 1fr;
  gap:4px;
  min-height:0;
  overflow:hidden;
}

/* right-bottom: map */
.panel-map{
  grid-column: 2;
  grid-row: 2;
  min-height:0;
}
#map{
  width:100%;
  height:100%;
  min-height:200px;
}

/* ---------- Slots / grids ---------- */
/* 路線名＋駅グリッドを1行化して高さ圧縮 */
.line-wrapper{
  display: grid;
  grid-template-columns: auto 1fr; /* 左=路線名 / 右=駅 */
  align-items: center;
  gap: 4px;
}

/* 路線名を“タグ”化して小さく */
.line-header{
  margin:0;
  padding:2px 6px;
  font-size:10px;
  border-radius:8px;
  text-align:center;
  line-height:1;
  white-space:pre-line;
}

.map-grid{
  --cols: 10;
  display:grid;
  gap: var(--card-gap);
  justify-content:center;
  grid-template-columns: repeat(var(--cols), minmax(0, var(--card-w)));
  grid-auto-rows: var(--card-h);
}

/* empty slot */
.slot{
  background:#2a2a2a;
  border:1px solid #3d3d3d;
  border-radius:6px;
  aspect-ratio: 2 / 3;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:800;
  position:relative;
  overflow:hidden;
}

/* ---------- Card base (これが無いと“見えない”) ---------- */
.card{
  display:inline-block;
  width: var(--card-w);
  height: var(--card-h);
  border-radius:6px;
  background:#fff;
  border:2px solid #666;
  background-size: cover;
  background-repeat:no-repeat;
  background-position:center;
  box-shadow: 0 2px 8px rgba(0,0,0,.35);
  vertical-align: top;
}

.card.playable{
  cursor:pointer;
  border-color:#4CAF50;
  box-shadow: 0 0 14px rgba(76,175,80,.75);
}
.card.unplayable{
  filter: grayscale(100%) brightness(0.5);
  opacity: .55;
}

/* ---------- Overlay card (minimum) ---------- */
.guno-card{
  --w: var(--card-w);
  --h: calc(var(--w) * 88 / 63);

  --line: var(--jy-color);
  --bg: var(--bg-jy);

  position:relative;
  width: var(--w);
  height: var(--h);
  border-radius: calc(var(--w) * 0.06);
  overflow:hidden;

  background-image: var(--bg);
  background-size: cover;
  background-position:center;
  background-repeat:no-repeat;
}

/* =========================
   GUNO v5 Station Card Overlay (restore)
   app.css の .guno-card 定義の後ろに追記
   ========================= */

/* コーナー（半円） */
.guno-card .corner{
  position:absolute;
  width: calc(var(--w) * 1.0);
  height: calc(var(--w) * 1.0);
  pointer-events:none;
}

.guno-card .corner-bg{
  position:absolute;
  inset:0;
  background: var(--line);
  border-radius: 50%;
  box-shadow:
    inset 0 4px 8px rgba(0,0,0,0.25),
    inset 0 -2px 4px rgba(255,255,255,0.15);
}

/* 数字 */
.guno-card .corner-num{
  position:absolute;
  font-weight: 900;
  font-size: calc(var(--w) * 0.32);
  line-height: 1;
  color:#fff;
  text-shadow:
    -2px -2px 0 #000,  0 -2px 0 #000,  2px -2px 0 #000,
    -2px  0   0 #000,               2px  0   0 #000,
    -2px  2px 0 #000,  0  2px 0 #000,  2px  2px 0 #000;
}

/* 角の位置 */
.guno-card .corner--tl{
  top: calc(var(--w) * -0.5);
  left: calc(var(--w) * -0.5);
}
.guno-card .corner--br{
  bottom: calc(var(--w) * -0.5);
  right: calc(var(--w) * -0.5);
}

/* 数字位置（見えている半円の中心に寄せる） */
.guno-card .corner--tl .corner-num{
  left: 70%;
  top: 70%;
  transform: translate(-50%,-50%);
}
.guno-card .corner--br .corner-num{
  left: 30%;
  top: 30%;
  transform: translate(-50%,-50%) rotate(180deg);
}

/* 中央駅名 */
.guno-card .center{
  position:absolute;
  left: 50%;
  top: 52%;
  transform: translate(-50%, -50%);
  width: 82%;
  text-align:center;
  pointer-events:none;
}

/* 駅名JP */
.guno-card .station-jp{
  font-weight: 900;
  font-size: calc(var(--w) * 0.14);
  line-height: 1.05;
  color:#000;
  letter-spacing: 0.02em;
  text-shadow:
    -2px -2px 0 #fff, 0 -2px 0 #fff, 2px -2px 0 #fff,
    -2px  0   0 #fff,              2px  0   0 #fff,
    -2px  2px 0 #fff, 0  2px 0 #fff, 2px  2px 0 #fff,
    0 0 4px rgba(255,255,255,0.8);
}

/* 2文字駅名を少し大きく */
.guno-card .station-jp.short-name{
  font-size: calc(var(--w) * 0.18);
}

/* 駅名EN */
.guno-card .station-en{
  margin-top: calc(var(--w) * 0.015);
  font-weight: 800;
  font-size: calc(var(--w) * 0.065);
  line-height: 1.1;
  color:#000;
  letter-spacing: 0.03em;
  text-shadow:
    -1.5px -1.5px 0 #fff, 0 -1.5px 0 #fff, 1.5px -1.5px 0 #fff,
    -1.5px  0    0 #fff,              1.5px  0    0 #fff,
    -1.5px  1.5px 0 #fff, 0  1.5px 0 #fff, 1.5px  1.5px 0 #fff,
    0 0 3px rgba(255,255,255,0.8);
}

/* 路線コード */
.guno-card .route-code{
  position:absolute;
  left: calc(var(--w) * 0.14);
  bottom: calc(var(--w) * 0.10);
  font-weight: 800;
  font-size: calc(var(--w) * 0.07);
  color: var(--line);
  text-shadow:
    -1.5px -1.5px 0 #000, 0 -1.5px 0 #000, 1.5px -1.5px 0 #000,
    -1.5px  0    0 #000,               1.5px  0    0 #000,
    -1.5px  1.5px 0 #000, 0  1.5px 0 #000, 1.5px  1.5px 0 #000;
}

/* 停電カード（オーバーレイ） */
.guno-card.guno-card--teiden::before{
  content:'';
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.25);
  pointer-events:none;
  z-index:1;
}
.guno-card.guno-card--teiden .corner,
.guno-card.guno-card--teiden .center,
.guno-card.guno-card--teiden .route-code{
  display:none;
}

.guno-card.guno-card--teiden .teiden-icon{
  position:absolute;
  left:50%;
  top:35%;
  transform: translate(-50%,-50%);
  font-size: calc(var(--w) * 0.38);
  line-height:1;
  color:#fff;
  text-shadow:
    -4px -4px 0 #000, 0 -4px 0 #000, 4px -4px 0 #000,
    -4px  0   0 #000,               4px  0   0 #000,
    -4px  4px 0 #000, 0  4px 0 #000, 4px  4px 0 #000;
  z-index:2;
  pointer-events:none;
}
.guno-card.guno-card--teiden .teiden-sub{
  position:absolute;
  left:50%;
  top:58%;
  transform: translateX(-50%);
  font-size: calc(var(--w) * 0.14);
  font-weight:900;
  color:#000;
  text-shadow:
    -2px -2px 0 #fff, 0 -2px 0 #fff, 2px -2px 0 #fff,
    -2px  0   0 #fff,              2px  0   0 #fff,
    -2px  2px 0 #fff, 0  2px 0 #fff, 2px  2px 0 #fff,
    0 0 4px rgba(255,255,255,0.8);
  z-index:2;
  pointer-events:none;
}
.guno-card.guno-card--teiden .teiden-en{
  position:absolute;
  left:50%;
  top:68%;
  transform: translateX(-50%);
  font-size: calc(var(--w) * 0.065);
  font-weight:700;
  color:#000;
  text-shadow:
    -1.5px -1.5px 0 #fff, 0 -1.5px 0 #fff, 1.5px -1.5px 0 #fff,
    -1.5px  0    0 #fff,              1.5px  0    0 #fff,
    -1.5px  1.5px 0 #fff, 0  1.5px 0 #fff, 1.5px  1.5px 0 #fff,
    0 0 3px rgba(255,255,255,0.8);
  z-index:2;
  pointer-events:none;
}

/* line backgrounds */
.guno-card[data-line="JY"]{ --line: var(--jy-color); --bg: var(--bg-jy); }
.guno-card[data-line="M"] { --line: var(--m-color);  --bg: var(--bg-m); }
.guno-card[data-line="G"] { --line: var(--g-color);  --bg: var(--bg-g); }
.guno-card[data-line="T"] { --line: var(--t-color);  --bg: var(--bg-t); }

/* ---------- Mobile tweak ---------- */
@media (max-width: 1023px){
  :root{
    --gap: 6px;
    --left: 1fr;
    --right: 1fr;
    --right-top: 0.50fr;
    --right-bottom: 0.50fr;

    --card-w: clamp(34px, 6vw, 56px);
    --card-gap: 6px;
  }
}

/* =========================
   V5 World Slot Layout + Blackout Rail (top-right vertical)
   - HTML変更不要
   - #slots-area を 2カラム化（左=各路線、右=停電縦）
   - #map-blackout を右カラムに固定
   ========================= */

/* safe area */
:root{
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);

  /* 右上：停電縦カラム */
  --blackout-col-w: 74px;

  /* 停電カードだけ小さく（全カードは小さくしない） */
  --blackout-card-w: 54px;
  --blackout-card-h: calc(var(--blackout-card-w) * 1.5);
}

/* 全体高さ：dvh優先 + vhフォールバック（フル対応） */
.game-container{
  height: calc(100vh - 22px);
  height: calc(100dvh - 22px - var(--safe-top) - var(--safe-bottom));
}

/* slots：2カラム（左：路線群 / 右：停電） */
#slots-area{
  display:grid;
  grid-template-columns: 1fr var(--blackout-col-w);
  column-gap: 8px;
  row-gap: 6px;

  min-height:0;
  overflow:hidden;
  align-content:start;
}

/* 既存の路線wrapperは左カラムへ */
#slots-area .line-wrapper{
  grid-column: 1;
  min-width:0;
}

/* ---- 停電（右縦エリア） ----
   #map-blackout が #slots-area の中に居る前提（現状そうなってます）
*/
#map-blackout{
  grid-column: 2;
  grid-row: 1 / -1; /* 右カラムを縦に貫通させる */
  width: 100%;
  min-width:0;

  /* 右上縦エリアとして強制 */
  display: grid !important;
  grid-template-columns: 1fr !important;
  grid-auto-rows: var(--blackout-card-h) !important;
  gap: 6px !important;
  justify-items: center;
  align-content: start;

  background: transparent !important;
  padding: 0 !important;
}

/* 停電カードだけ縮小（slot/guno-card の --w を上書き） */
#map-blackout .slot,
#map-blackout .guno-card{
  --w: var(--blackout-card-w);
}

/* 停電セクション見出し（もし存在するなら）を非表示で省スペース */
#header-blackout{ display:none !important; }

/* ---- Worldモード（任意）----
   body に world-mode を付けると、路線を“1本だけ表示”にできる。
   （JSで .is-active を付け替える運用が最もシンプル）
*/
body.world-mode #slots-area .line-wrapper{ display:none; }
body.world-mode #slots-area .line-wrapper.is-active{
  display:grid;
  grid-column: 1;
}

/* 停電は world-mode でも常時表示 */
body.world-mode #map-blackout{
  display:grid !important;
  grid-column: 2 !important;
}

/* スマホ横（世界版本命）で少し詰める */
@media (max-width: 1023px) and (orientation: landscape){
  :root{
    --blackout-col-w: 64px;
    --blackout-card-w: 46px;
    --blackout-card-h: calc(var(--blackout-card-w) * 1.5);
  }
  #slots-area{
    column-gap: 6px;
    row-gap: 6px;
  }
}